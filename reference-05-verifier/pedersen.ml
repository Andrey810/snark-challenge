open Core_kernel
open Snarkette
open Fold_lib
open Mnt6753

(* TODO: Encode these using base64 or something. *)
let pedersen_points =
  [ ( "332637027557984585263317650500984572911029666110240270052776816409842001629441009391914692"
    , "256729384495629324506420372961192720918348265673564549794471951979904664963951714723671245"
    )
  ; ( "317636346738201844363072211531037005916212220880107581418751757742684937914450594188415214"
    , "34528004492629100771376637597612406651713499584905780489286194141574291240293310116415477"
    )
  ; ( "301993958032627472884437745615529438033253545721338569638490859186611357261503455475144560"
    , "146838269365541568898424192297459095856365681624642067425805412886771331230439469722095457"
    )
  ; ( "128129903535426931605566944870567299118257828089601530702537687963370272749913056019263948"
    , "241533714158383240264541770223151071469220576304583859791081751809254489361787785034789292"
    )
  ; ( "313740059656320278624446394988661572874903691784478118184415417081043868987379996532675000"
    , "100335334128845081242859700333050668946392262163243686493207843641156092956137855903739186"
    )
  ; ( "423183895593383061799561339264968652038340040714054275680700025954978728606721325061813986"
    , "313969101172182642564501383126895492652625186481651229385533160513306266107255895040965835"
    )
  ; ( "96515863600062668253667988564365773313561516965030035964759662895203654760595267751273022"
    , "74788359380435946369732993003083344506070059318176369841012459568171255289307688643768892"
    )
  ; ( "133805277542469035530250675647787997526131024301973452468057797508664393260190079584060932"
    , "473248979559415085339364815352614347743448895122993254491829858719453440371739397007461158"
    )
  ; ( "193145450621136862339560730801073269842002469065910956677832837218816947495711002260152576"
    , "16255012080098881505792406186591030441202762121828886745554048531238641365799402942870343"
    )
  ; ( "227178667986388803585115344621131283407798287495545402043280943015629427526751052148991114"
    , "475003404954778522592169245938178450555712839789630810550000761777308152460251354101521050"
    )
  ; ( "423133681764677277086792611137892122334228781032625093129146984124166840674465788309849992"
    , "365324352402801055309192141629343166814047966867902840699773790982764508051119135029931427"
    )
  ; ( "78561225664302523349092732840437117200157107063502622690927391795648402229434839895786016"
    , "273915131365174588538713994943751514035209366158396128368110797691913109035170653932232028"
    )
  ; ( "159917236840730453282900484619501147586757366046923763370700801093498480038053442177223818"
    , "158531250602510576269487572133855000249711477358108015479791730616779411911933621107878679"
    )
  ; ( "150072202624053753859902143232430667345684482977074626317414246486425194885468440113741938"
    , "185055570473661937557797010226071455697394227668489375045865148608710730771601162659224761"
    )
  ; ( "83598718932458285076036453015153036940738391897046961246944764529797351898700183784611794"
    , "443180616489645981327215639531514094202115201848720645183101376166116333548147646851468745"
    )
  ; ( "365463925980135361910266159800510335931893202059613218879288916454398451170776445445366796"
    , "136758481647652739173631593963851670192833256737302335481890716040032188318238042797850632"
    )
  ; ( "181941478050286549251788254617781802535470513923558184708445298606689697682297865377076462"
    , "190418711677020109523606401330795377037931503072398096931341176531835776385252650172346950"
    )
  ; ( "16454773040978307327412015821887523343289827173796054172310195775020070479249431368698644"
    , "391954427410644043323702202556619332184617942936010400125331446299597903149297058751917334"
    )
  ; ( "379137235281194008784901543963950904420438490095682143881866409240786182711016851061517988"
    , "5704992102465947754227341975704954353219942547107348991636620676690724121096044544903019"
    )
  ; ( "263337764690951009321327941014465924370906496699830801007584435017601654626099399302793778"
    , "24860071735472575585874756537889505603019321944102063099887889265416443822843406430553582"
    )
  ; ( "196966122256258839215912766981079631520690798679181490012968528294769696691885626574914072"
    , "67443473085459729479168741105720123892294683675759499698598628473461154000684777058637891"
    )
  ; ( "165900430746442503689437812403186354213911504297364654661432577585228153751211757664486398"
    , "292022305692114921344825645676702882732783678307209142913610032919440795250396807556163374"
    )
  ; ( "452189201080347246872288319609559455942061578101054587542288955258490019828380348918997136"
    , "209303950680842799137209028267886516540451391570844255777490883047036565108501911369715300"
    )
  ; ( "393609331141331418714985912113935092795515792879278344906208487954329474729378410434265840"
    , "419539339725280306289025263230877378902533379738545712683636447869787579914324047266538579"
    )
  ; ( "205701834301562764012489621430002464068216034572643736917750533263123872993324961886324190"
    , "408931052782631228074278482815282611259430707044688219487838612557579235479756250285693199"
    )
  ; ( "36684049608151180626049806441681739619752180260744151309382220069360978995525658007287176"
    , "196228298053876674476328435191149200547192608931189384045312077060862735827382307744729494"
    )
  ; ( "287941052060237312129062517455880093680587733544761349596148738215898732158683609079806248"
    , "358692025708933418990960405244630337466646334253875579052041770687950437769757829823690983"
    )
  ; ( "6969386392726125197081394698576229569640357493989637922041652856330858788167478911146054"
    , "421147000559968831415589201900398242482366158244939974238300796965707953330224938880221823"
    )
  ; ( "475420418253570001485177376487053142882181494624962322898265063318599823539462432563899040"
    , "271184847752447794569064555409141469671224456729088035872392709263732787923801761852688794"
    )
  ; ( "63574834853157170735638596276264126086221567405245288327542183048253432805313834986452298"
    , "35020983346067982084232996994689512732613182978702349639504579462871005426634939813067275"
    )
  ; ( "372827018645011427557420580712353609600150856332729728891898987031817775985173117198334842"
    , "387386186681446078218491874337119289790886585644394208412361136495640059513898304308824764"
    )
  ; ( "363380236122363621197588573947999596992522983685540471152080212797491091650393343940522642"
    , "45370399084135489283475409360234132926710514398322250421577477474025936501208353807275508"
    )
  ; ( "291952591656717785721408103140844979878206749195070106124243880940584761843430074619571980"
    , "475759259509634965023752209054502893366630277807845673862251121398440908915817637399515125"
    )
  ; ( "149251649979258877041208563083206717792559093904255095678456689773080546572517572358789718"
    , "160850919866128430503409547426790090133267187265334158549492883154530011381755279210414788"
    )
  ; ( "95260702250483976558389756385071505191114596785719646198066388814418913946808153282412310"
    , "77480789709252133782069320652898074389655197808356148198036120546769838877714147202570878"
    )
  ; ( "389912949619430199563111102383068754983960832269658423147594759757132532169842298554071954"
    , "73540639181137622090564697052917266337118351767010444638093495575915397577400687727733579"
    )
  ; ( "463434117874474083950897904673322394124072888069227848617936714345036345359450646399962826"
    , "409294658677668256549096062765154488806922832280785647329582465636936979182631479131410502"
    )
  ; ( "471953020275879734758908285701358460319404627747558653305498584166048372761210441825364336"
    , "430753892827399417600547556677787661702516702013208532049230790730395067518005580644787227"
    )
  ; ( "234233792584353542666776606383251477495906123611110384277940510123374499868479448003267270"
    , "294555232412430334856945966939232895892483778915694748392796703346323956792459122642878610"
    )
  ; ( "114221292303114933291532645256747380731754988376662882144171296910895490763078980190984156"
    , "315181313838716953085414457878092042821765418026315474413114651510735211438128130307430655"
    )
  ; ( "468280008407543811465545232278295933186503325742458455902048879390494014858336152440403876"
    , "287460421658031887387005885695283221990252381212480248761149320797519639108314524908297430"
    )
  ; ( "425062004680402706469565483584958996327853050769415303200617123165968530426050785345745076"
    , "231535301043227461416755876757069693527987612217777840041305446821057258588998173082295701"
    )
  ; ( "396891939721181167191955932780461261862491840241294809281220820565861350879566286566758830"
    , "363635161794594454591896066660154880435823298120722876704838499072448180167528392265256437"
    )
  ; ( "375959891059017640355797340137854002809620200289315759255337839359725117157276132739862846"
    , "329896841345720210553838080253581163652099511509911756562896186686801904912564843879340000"
    )
  ; ( "14415885808023639502064266653364474840416966575562368628561389915794123756722570720001404"
    , "222684664397465634473539608516082807979121603314995148036796909098170210570550832326359926"
    )
  ; ( "138585902746259372164765180480337397910084558832917841773296543430007231439636309842929322"
    , "367747937839743879022967549087955411181017806466308943982593232339050501048657135069320371"
    )
  ; ( "407111111325567694792180982209563761135730849927214722267402360016831670134631131067496982"
    , "437746219098565938352522448381352636206236096344705396137621242824612898371980048337613005"
    )
  ; ( "363864072428149876375391784102443524542737478716967719948439150718833215471522013509513746"
    , "175581719315780577163667758644204917880417014899255158586315165159034725214197134947182630"
    )
  ; ( "395910128137351803047032649744599676231249566288440313972700334831138648175014106094745840"
    , "320548993219178110568048260012301992610022282098096131049386886950008850377334681492512061"
    )
  ; ( "34530134507176209796863605311656107557716358701805220502128571268352748471485653798993944"
    , "178240346134894041739564919594168245299577032234463293224076527188443135206179079147541374"
    )
  ; ( "366455881454210795385409747903809462941017561833810382486349113113578197729270005262467638"
    , "315681144133034994869849989032061898545756659640836725394431493491440821990312483261923953"
    )
  ; ( "51550608675969070361784637668167350438489444491791925726382871906942727100956512303454056"
    , "107258494550636948409471183621614881634884842222618215836395095867988237112564372766090888"
    )
  ; ( "132062779686238115452680987383156280212821076539124214778642456361824059369545901771751862"
    , "82451320849070164538981425620729034312321827177007394651946152969140115458133709294565752"
    )
  ; ( "74421687585895601311852580286613375822201242250654299504276206710517269819701748266282578"
    , "45069529472213583251668850766196350285076081340655503606138587416637560804845469705750152"
    )
  ; ( "215959642900812043545306274628129366849345933282121263390076840946112115752659795377701290"
    , "473426963607115589502435114687918423352111483794340486905951517145829587273170679986376896"
    )
  ; ( "409444468621478816780759803555008508315300123895459305804142204121429808377432257287173732"
    , "92400141092725528764666137174848678342287449684950625055079347330243085512305722873001195"
    )
  ; ( "29590894808194257700440780272531191038788159437893793261349508912524275440783509906581738"
    , "130314143620334355119477762166030221225724067020541509246388546017545584377765683240306640"
    )
  ; ( "303715802637387116403759695224686838121876427802643372666842380099828263673697223984608856"
    , "60876317092544749453302832741154108142171741499560930304713866377747493523540520234428563"
    )
  ; ( "293043405260790848956396339003691474493243707114216781733052118010430371301740784894876330"
    , "258145666907066868560525562135196637808526607906530848121566951194461485219948852398462992"
    )
  ; ( "364044527681927265418950189400564123021891140785753215286761024034158274191725412785299244"
    , "114954283281610964592409878752388458098500614362011891182640014352712409568940950179179635"
    )
  ; ( "264588066819514087651642492068597613468650721142061429041791518284716302971421557222229648"
    , "474568245685204797768919408939384458743663992129975847737756713343920358135289217600524226"
    )
  ; ( "210450074358308786905601332982487115604155439599672020265802988415041887866661170718596156"
    , "125402343421666846045889709991313472966445302583303874457525174769247335591689372751060379"
    )
  ; ( "316572151969765182326625821440470688267894046452252512524339076080141008033796280325687206"
    , "193182406347443205947760125925062076670701881255060451102268971870586527805385959549835290"
    )
  ; ( "307734332540486850017653550681169166466330155862840030258600050989892013852335109523893184"
    , "316249504058517955682648014023618597547146447499960854751242378446477830976033177865428714"
    )
  ; ( "362996066170457525285507374262554114462510691397767903054083645524456684028002385869911798"
    , "202032016281994716472958395172301008784388615476127484583826662580906222292426893923993734"
    )
  ; ( "87586000771847382064153094925143027089684594064395437180672246620604506803466591955133526"
    , "31173283086882404865154954586324217146092069236690998161757111098614841692427297762813482"
    )
  ; ( "140881600123297795345942122427267349407727653760553123962563500339749379889979878878185932"
    , "441926376187283104749822000788866039175668427706532862105027942074534251411602506483037237"
    )
  ; ( "9153034408963212360531746004604093863536171714964963276635354382454531904181652439305852"
    , "34681816664250087915229196373125824305324512835673743220300125549475983978588282443657691"
    )
  ; ( "475202446528194652730523569407515920124999805158309782090406961925111237914826472531495958"
    , "314184730060431380665804946691273951166744721900210119634761631725155784493986068461087761"
    )
  ; ( "227624374644685751099393179700817250379254376158315474857674066365323500584505393526359910"
    , "303885564574724354241174022410943761504217381999026306019051087086520794866701840160231921"
    )
  ; ( "218143262803144689647602880719536390806408663562689521199385684224180326021038961350577200"
    , "255210872272490232962615054351023390066971671115643265303121944430800957771421101682790347"
    )
  ; ( "173311621600912934093968727671227537002218605409055958446837083731727874200999621994299508"
    , "126334131502527979263389087404904482547248663578593607872760104682398707034654057073673086"
    )
  ; ( "18153690525242607213712146339545614615871778153487926904903486284799932329831275231716554"
    , "193215453254528773389042197259232284505141696163720288993080311428598441291359770536893682"
    )
  ; ( "196476404259876475887332167727631966830908542446196632045778097023417448633610456608675832"
    , "428058269232719250504093532551428766742453627729964229654421618751373388122585178215195058"
    )
  ; ( "117844815154089679131461123911754218425657286442337772021874428726014830905768138711071818"
    , "142040025589850696304477696473418007057724436467514522571636684957425487485565692222049173"
    )
  ; ( "144541104612051649453755178161457899375630436025995522635710723335859666615158324453912056"
    , "155637160199820383553478911382971754325865424118666645078890835358585522282439771211816509"
    )
  ; ( "417808107815347365765398088975432132275547719557160858420221071086316950885030147841731916"
    , "447491386494980194547276868275047663671080972257188517855492439865294211906047472154536021"
    )
  ; ( "200747170212878436237999338992617025136596071395859005284110164174465985816157205793716348"
    , "339847623793682577274970583148964154631824197725062288612939413016566863590265135445238872"
    )
  ; ( "68110069030782814189426771327152171122013925583059623455238527824807391784680666203026618"
    , "7909798518753054499727624645000971715832040891540057826518207035345686937509666483124200"
    )
  ; ( "19998400184664831666818280971949027393776324902255385947141313395920210492272743255387942"
    , "330270263448832024538941025044570392178755128769945217892755504284154472372156527833393682"
    )
  ; ( "343435715165414240015533761625076527076538794196011824991446049258030096787783433085955248"
    , "206629802052698297556214276664624453370983466926155973604909482736876905908485033412776852"
    )
  ; ( "185292921251574170934209545561570959541124786230971199038194414130781988839502613594802492"
    , "462542697949428541937237970702382063312998442796662395528015554070174432025109295903668429"
    )
  ; ( "93309940105670784522552824143942162791149647367810601158421823792735846129165566230618266"
    , "160016591422563167247195421807871077758572658212947938889439843332236221309468163093228053"
    )
  ; ( "117888287851644201523978147137415905150246361769927751032982721673551601073705100588198964"
    , "146621660508721332143068475446807805656360422411781953646787350639321386909493822173382511"
    )
  ; ( "129540413652650422474605895652084069995467359415738815994353096900693653264741492146865980"
    , "2832224566507683711018034977175626968957269789643673037453694416055483852425980943805548"
    )
  ; ( "29787257002655147184630020722887894188280852362540668625608933551752529280373889648555978"
    , "19314888999592491919361907103974239103180082846018284457504447867084682720560520892028706"
    )
  ; ( "301855553664587396897979917772872167203470543095799174592030529147302039015900959683317444"
    , "129501081797643655874025330596669501720742668571162576407137419567725952023712516781556040"
    )
  ; ( "110153468242068769100411071320967731409641530722554958314950520604804498395568006599337668"
    , "385235430657760975896574657885334054689148065739037626523093415918181892181996209633576867"
    )
  ; ( "106569455517033002633668463647117641871573702618731138384165441688209576785975189967530798"
    , "450498053397284946282364521771815271695913781213209426236151213588214991575954382844858947"
    )
  ; ( "165092716307228520376287712536542498965012122847052072715182995223713288860508272718155138"
    , "336252205030832385294612756644016491030098550154317662896163099346028445416286703595092065"
    ) ]
  |> Array.of_list_map ~f:(fun (x, y) ->
         G1.of_affine_coordinates (Fq.of_string x, Fq.of_string y) )

let triples_per_scalar = Fq.length_in_bits / 4

let times_sixteen =
  let sixteen = N.of_int 16 in
  fun x -> N.(sixteen * x)

let multiscale xs =
  let rec loop i acc =
    if i < 0 then acc
    else
      let acc = G1.(acc + acc) in
      let acc =
        List.fold xs ~init:acc ~f:(fun acc (s, g) ->
            if N.test_bit s i then G1.(acc + g) else acc )
      in
      loop (i - 1) acc
  in
  loop (Mnt4753.Fq.length_in_bits - 1) G1.zero

let pedersen =
  let triples_to_scalar ts =
    List.fold ts
      ~init:(N.of_int 0, N.of_int 1)
      ~f:(fun (acc, sixteen_to_i) (b0, b1, sign) ->
        let open N in
        let term =
          match (b0, b1) with
          | false, false ->
              sixteen_to_i
          | true, false ->
              sixteen_to_i + sixteen_to_i
          | false, true ->
              sixteen_to_i + sixteen_to_i + sixteen_to_i
          | true, true ->
              let xx = sixteen_to_i + sixteen_to_i in
              xx + xx
        in
        let acc = if sign then acc - term else acc + term in
        (acc, times_sixteen sixteen_to_i) )
    |> fst
  in
  fun ts ->
    Fold.(to_list (string_triples "BoweGabizonHash" +> ts))
    |> List.groupi ~break:(fun i _ _ -> i mod triples_per_scalar = 0)
    |> List.mapi ~f:(fun i trips ->
           (N.(triples_to_scalar trips % Mnt4753.Fq.order), pedersen_points.(i))
       )
    |> multiscale |> G1.to_affine_coordinates |> fst
