open Core_kernel
open Snarkette
open Fold_lib
open Mnt6753

(* TODO: Encode these using base64 or something. *)
let pedersen_points =
  [ ( "2071893303198007985737678972190309212568452221625132024511988170095494148670997278812694070338313361389889122280160253462982652030041813566301365289695187505618174204273471887226695702458395861269694368663558765191107385382142"
    , "17187187414417664367585796530257262302159176591062800465884265459977066325098901507827719965058588341044788483232395252403515861767227243983849894797683644816538861625368393588001624014759720661490214325432345769098675755344007"
    )
  ; ( "12212700530208157134689256057121042620633735483309261868159828729358269133353025097021648766749096328904625282610227267815597560656189994727627613599055093979638719153187781645363642530065802177696707603573183038198049837281284"
    , "25783690089010390455572974279288664362239817189553105020262800542618336981545722940934884637537924384027963108482794866752096889610121505188228870561534980224779056104062778099246844511975082198175449341056361726557212816273203"
    )
  ; ( "24970556048065806436025775756019294569514287852390684813064321958272933228137795169157911036418821145649315804385644486444483724251269635399290126638401987231852781394516304251109918520031098349546899855265794613791318815401876"
    , "31962426837049224740980485154381998358868991216693595616538747324158910634872015696123705432006307054685021215563881823301198025102710386453970240354239402398745821628720107919855566997584156778139135499881940592882629489943551"
    )
  ; ( "4431264411717549274439490659582560401278429696218324463252012866668010436230467390709079687847260266333949609702709398614735778908621392906775244210809408019439483728382538000678063011124654256466867465806472450156285959296478"
    , "5357104929738581133630585435713154584790058687516758823722160588386982989576958329026493218285464648215758171648009368623425257221760769388865621253647844864279048734223948216626860899712215839882580351969504555475483295828321"
    )
  ; ( "6671433602972561813695090966408317709238420789110797829702834855105065892311048504872981038933746208133427345903147737968972400166128764694941204592973429712710593028851732935226387767696882706160253984317874861465334699161990"
    , "21711555364470068355814107901005676801426239531219087510381972880175131973242407029290710493957974865954350244915332826635503654142837214217367474143450949577779528038476129095441904192715126325925180200706764720129647900154510"
    )
  ; ( "3279287280516667726034641228088153493377068947932964914992332109534304163378313362642088339811737854700479601646880961405137089274374094406319964129318466368217040667072259586616947873396338805588189680637610631077799406849678"
    , "36083410532375699766897530133147718931585816209038495573380944607379201487163666226805598827634658263382384531791578426004569849840500849793075159834066479383773342040065664681946311465722831163353980052849824208445357276512039"
    )
  ; ( "6080315379067559396366920603391445316068884876999059159889161166465434118824372554207399274504146495157531657398487486565476348416859948241407968265138831613853730297645692192334843976583486101896736840413872097839964499683332"
    , "26420424881408892228870218588074681761407815765852299070750308032078795079763335114222685666340147826454447640325063954005645285100365609355311780905109783862569185820306941334828547063301806152701392010289886220468661953965919"
    )
  ; ( "39301831400422949389818222554551556278076967824511010861535510094278551646323817962504510429949535607847124719220397592919414191667356795652722963307663320704947997484288198213588564623546419124090570040138115255574753268044296"
    , "36457812814376230890682190373753614518702525324272794059443925877471853974877472140825740785996758245920724784158181335975363784020543877031746359325492875482739908200696955809723414504629601464266420637086159099075048645416374"
    )
  ; ( "7540664997550190973602360351030883142324749771399862809105176292300299526593722518355361727448429173635571954137685816627918496116227546648451982643232613412226512084475776533244886987139627138835739493051117039845249333293796"
    , "41832168374796125531735699856185177965741887376998317172586340222379811256102274861246907652644659486244227261842256173112551393210515106271575307252302330588981902151799763241646966710905966859708456096352215232407040721812440"
    )
  ; ( "36397483455279521486180767892445054628947434149047678403043888842127539677645442740735471632069262625023630925482329096023950321390546066181899597320416634680062586092646310952310844092327312810134226425393239318043723435147242"
    , "18286472905180979924646715322917829676123207845562357760879307637733164075896656550520464980631401874233327857749869297454439627725894967171722892001304897028600380951109713197296853450963512190698451016172641099337226932835103"
    )
  ; ( "38971740405150801303656120540964048311055428317597420804659853006910052152298169876746036294761470660390748610246706280407819428237389693394271333553585474382213782764591195401917422695201611402679319607462045083981820266292526"
    , "12052300622245628070333354588755219239307478469529845235720526151711813563444656737524423919201679934065964579148677093493832843694922101898382470265577630638871822779691658559083989998504649770048646951871151837463810472588643"
    )
  ; ( "28580639909521896467730379621107007981713563598576419274286032656030060646413984885651670728423715399952200046109842062405825188571385283021073346904536651485834210457583868625103914909503900539953858010694440026958408821693616"
    , "33074070963001755009804136607611008375296623364907104158069380168975081449307467755506733151497347867221785696657950398557975950305507047259982036542250828282873739093067701764175433149313198906930824052021363292166457216217373"
    )
  ; ( "13952673072821710927373743250956705810301215243260672508356091114567279682302329984435345484954375032938639798459465391849320814517925779778338314957991849014833663775803070848153326286085705889754741589204615117572725896988858"
    , "30983284140334456851061430102389529908408959140704453607486433533411367748181204276657423316546795512245349558100176842368313691169126215113867894113355110185206520060674173818693795315291227885657384495020097909347433568020029"
    )
  ; ( "19290042561116504970365442222279486868920498104673307669217034472620877088701718877393453388363862683170877809605937696259433437570041577800093930382602132445115119544022603336322588892981233110652691158366447731563470819022452"
    , "17538876124380925643222028394283356308867688903907894053656199434667813568339227140964671608709763009715157071906381237300234616779157759163812636158365288205043523074071708603795019085845150122832764044203773099673273382554876"
    )
  ; ( "11903656747753516676825002360587942301400404012617956597469770714175747767494878498962804409789079968956911491062041077035821094610796845979807463924999318614678918940111788688915987986346631946503146408072971985676844164591646"
    , "8514225123328519005234595341415521311872694420281447120478271770539059969548428106062925802825842740943072824220885919309459864534873639960568084719935743365409041681394377456439059941848662446341543471396054168497587637406191"
    )
  ; ( "7344413449196796930298218516443448077762285660244134876627245543091721103863543138608889785827533338099808547216760226801142608503982895124915454376131803145994263151597370272617556903104376909343302845493991074922652539099974"
    , "2958210017451329919206142701231501526322406039832587256747079126642375558086256087174521111886146235281377370380421327064278970276527058175332659651099242988467053341732607010309103064174781774035113504726884354639392646269475"
    )
  ; ( "157066511584664776112943180503426174247915979885873222012778383233047547992643883117240246140085246031027225427119072142904667484131895333368044073143431870156745285500934421782643384143869207403225797647526254967038707929218"
    , "5322525447924364528921574619986688621908655380468153229482914789481101087133109849468613336662159100215337555672687176856066513418142228124963230289546627803935782950258253456039047122300422198149352418388109707965090895826517"
    )
  ; ( "976735803983274736406069705215534367527886494317516209265600838786239508081893649501555138804882909729789394497244509920838952571079028416518746866475877231643627617782610670403305563000102215443653477712816884105120880876832"
    , "28340631828230001106941920671643045628921685852110897761922360408449424823381446095973311150394504379378803713444492208634553380681925819983585227523599725685170902457057684317142303070146411583435668668071477805358509932900820"
    )
  ; ( "24587895472809575430932878607403260808108619396767422072869515716198920383135106402698880333227276593855432825819672629962076729765593906090918727333406322419563942187300673537840396163676819052441245234432831276397592402225070"
    , "5208048179227079135705616869273467345212784619944781325644640299791783780670444512301423767389629621076852481506990295317523135077456024133859943768282347999423960136788373678925389860257377689387898680524686179183984944706361"
    )
  ; ( "29088467193510455147630339490032286838445011523345973920930635282749690964453637402799656917139537020536019166673330583175567476078101962214323837861727719054745215952135521878313664682073657619049757620515825735759274039911516"
    , "22096034849355143128889301716602953808100871647215630079342159159879997511747992255388748428516462442959474116690165955565190443685437796652188167008381289841357123790829758721534360198977109777204087961750127174306639240988512"
    )
  ; ( "7875773498998471376680118011458676427308514703331240814294912220797463077592463473833026538463120784595576410913120659652334845810049934227431138520867888634861154628432556810200242930619072537246663657494572436789240391878258"
    , "26523822359627054867954165836317187578270908525249199377969073322791612229499055285686953889326614443028249919736714330226155689828702195524564313535092728036560985925766972880740226502868938299586966902733806972378515809905784"
    )
  ; ( "5747379945979799367911253785820974127894473429751048393964674419967471573987827189040176288351917835654507528018753877260277123304185839401907809213339519650077230686964170835969957994304283138569088428962362982356774761939480"
    , "13908553444978863159742868786433891354679393992559268114808227672207430662420599211631650817073449821153170178548704318770159590838405963728343151296748312387192938596666948899818085023442695050752291778502178236900076627986932"
    )
  ; ( "8483530032029384316702336375749028359663494153103436105138005735467543792406934060426816382059697009513235789400962610893023682089332644877118041770320325388057453277742579564541358795326157093259499448988357836337220717522350"
    , "37478899773630088973362856786816984070487100515616747938119706361276986413159282585623865227950100249862895309001522666014550487864207538868138128232945052160799832079125543073566569358357511777820673315358427833779442028312842"
    )
  ; ( "29461559782147267159730841996588740885683482494283002201657145245074644630468149201308571360797238838001981884322033069119341604712655040180377678165735764196288482877025521967669970969732682798809286372082648227557441416465926"
    , "17650100889389473521798526983413206439907291078491396092866853600867150225971045364676093436839045687808573226948763002336357301297747969476028504943680648191737122459700350323448144485668178791443437210507877614303083164584408"
    )
  ; ( "19970623027154691852460196992836632351638072712339921787932200080346418985647435036351679296870885590891332844758212522513613459629613372066161591353275829576596545936367932718123474613030804993742277327325555574396028004981148"
    , "19968881598795534172790695421311499773283083326349926874257949529136152385912183889107294955250267207612240770326552253359700023735495526805871374881474864407789248875822731095937217017806092446398150133448283267318772002864157"
    )
  ; ( "1661832549717627139480747833077123687123578121972095927847911175107039938438689601963365673557520284136079962698372263606712742823351333385666159681571802041792036622522863363672346849711506045679930809434758479421099484577934"
    , "41489504315887552436726871769490686366136262908329252843133643865526262874747428045877677894688093117827113266968527214547073754718594740272302385507249820137257095129092152990315608060860485796966999694952331685762779890705542"
    )
  ; ( "40432195730029908885874143130946024960054274598425092174644540463547609158298527796681037212341154041387800456189444057185220485768774717458073892296247211610740471131389036426222209525341623927253854833765942219259110104002212"
    , "32633154473151077128392275137461505003905763805290090630327470368754002268242273292747342137452797550821013030313280425622065193348038894841261929373278947904444864836857826683379428631721687851350838156897718423513190326328768"
    )
  ; ( "16574057893941393337226906031474593060000712025174420511895731651536236830430062622995140357651682338505676388595196286964366419138924483594121002285387370953430782268472605951172368389041037230356259725367656951276092543844664"
    , "38325602795931043960131429046291443403226664589090289643298157148066601184114235399790876697817097460224918946706921408255978525208066026032138202538997726760023958223941886998801240023059628870661732683503073025755890856682249"
    )
  ; ( "16715758444081198219957413646619178288726880589662409246974097632176169229139248095826193397344778732816470002568724147231641598153313540385600291532295212516937283078470985849358392297076065510968569144780370698384190090329516"
    , "32374436439195540369046874764992929617183889018403321264559991519297204911546536103085809445194034467321405776524219443249160099658768915487178024044943648956060594999793763075600878086096753825354171283110327773836024957024555"
    )
  ; ( "16526322652388138637024110564534858164292542880457369513395354571372735593073495419724789134434892959918969975204386481938664561809062576877380470643367796460498721481733395835543636397684886444752691591455273967479249914064312"
    , "15907177974116897797174490455590735184109161111497570700653267546864664942463016209704091007661583548965809436588184657745419845471798794779282132657566683377309117783560531441855215812305814304829597742422011364799051105667630"
    )
  ; ( "22132569409615887606485227849901042700587174003966177209885058570583220222302451832895926931808049687783369556540549377344256578153872644767148710838220379513117666855118159854998531031078185825467231516415702512119654785071904"
    , "13888430215885136075667742362267025770612616726860410697760949346876894291801107618015103982771777585024824711400155769774852348071240078064573370123636943620110420834273450156238638679792996263046071252874458151317013189570362"
    )
  ; ( "5213731075938868733526863923309439860856065277206318368803912202353049437961389924296539887088513651399915160283251463807100718628584822869754513065542785406304825898844803430394792863384578324368465184034498563899654151316784"
    , "35109578266090764470060573972428101168345914040101175987890505240920324379435662293183501754821073815224696150350338226952901425954229252132196391486386259320375818521876712157270726782074894869938887505052018569856342927756773"
    )
  ; ( "33403686704300686173637186009204016961860336583972709821865092006231650021688972932439742078442746130358817312772764331256783459867636947298255592831477755019241864417858702104657076042611477969922394612514723210103559735972550"
    , "40729092441879338571387004087270669905772651209879584723510180955694316446455590866672997860927596458169585448599607083069101346287040420974257317526103512162329309827974254088642941586236570477619909672441398976771749006061146"
    )
  ; ( "3101641091745095184532075414671064859628608065182512465823348222325954181581303099207923897058691874933302678453918211797171790083399389176290150633661752203161056486840519273022829065420717299048870314589479343206359190067350"
    , "269783187171276524309414475318141943772279644875230597214076357311902769406213844443345689330561986787474176144438552393800194182680761650304895911524574747628807259406191109222759505937351433231011966787941014004895357101745"
    )
  ; ( "40053499468648191066950013182879016488442787056948074502242513612014742013160447105748925309981932230715730522655586189140654407957775986782727481853189966199606239004298607553826716074991001667458330283017838232085147288709652"
    , "30108017824557759507120504660412546067076310980216895483685974720942979335088062958303984845188543637151494438372986157906189048271360595760302153054695825247158066876543631794114742300702415170159787878693688067626352362446181"
    ) ]
  |> Array.of_list_map ~f:(fun (x, y) ->
         G1.of_affine_coordinates (Fq.of_string x, Fq.of_string y) )

let triples_per_scalar = Fq.length_in_bits / 4

let times_sixteen =
  let sixteen = N.of_int 16 in
  fun x -> N.(sixteen * x)

let multiscale xs =
  let rec loop i acc =
    if i < 0 then acc
    else
      let acc = G1.(acc + acc) in
      let acc =
        List.fold xs ~init:acc ~f:(fun acc (s, g) ->
            if N.test_bit s i then G1.(acc + g) else acc )
      in
      loop (i - 1) acc
  in
  loop (Mnt4753.Fq.length_in_bits - 1) G1.zero

let pedersen =
  let triples_to_scalar ts =
    List.fold ts
      ~init:(N.of_int 0, N.of_int 1)
      ~f:(fun (acc, sixteen_to_i) (b0, b1, sign) ->
        let open N in
        let term =
          match (b0, b1) with
          | false, false ->
              sixteen_to_i
          | true, false ->
              sixteen_to_i + sixteen_to_i
          | false, true ->
              sixteen_to_i + sixteen_to_i + sixteen_to_i
          | true, true ->
              let xx = sixteen_to_i + sixteen_to_i in
              xx + xx
        in
        let acc = if sign then acc - term else acc + term in
        (acc, times_sixteen sixteen_to_i) )
    |> fst
  in
  fun ts ->
    Fold.(to_list ts)
    |> List.groupi ~break:(fun i _ _ -> i mod triples_per_scalar = 0)
    |> List.mapi ~f:(fun i trips ->
           let s = N.(triples_to_scalar trips % Mnt4753.Fq.order) in
           (s, pedersen_points.(i)) )
    |> multiscale |> G1.to_affine_coordinates |> fst
